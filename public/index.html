<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>iPhone 17 Taiwan Store Availability</title>
    <meta name="description" content="Automatically fetches iPhone 17 in‑store pickup availability from apple.com/tw." />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81'
              }
            }
          }
        }
      }
    </script>
    <style>
      .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,0.65); }
      .dark .glass { background: rgba(23,23,23,0.55); }
    </style>
  </head>
  <body class="min-h-dvh bg-gradient-to-b from-brand-50 to-white text-gray-900">
    <header class="sticky top-0 z-30 border-b bg-white/70 backdrop-blur supports-[backdrop-filter]:glass">
      <div class="mx-auto max-w-5xl px-4 py-3 flex items-center gap-3">
        <div>
          <h1 class="text-lg font-semibold leading-tight">iPhone 17 Taiwan Store Availability</h1>
          <p id="subtitle" class="text-xs text-gray-500">Live data from Apple’s website</p>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-5xl px-4 pb-20 pt-4">
      <section class="mb-4">
        <div class="rounded-2xl bg-white shadow-sm ring-1 ring-black/5 overflow-hidden">
          <div class="p-4 sm:p-6">
            <div class="flex items-center gap-2">
              <p id="updated" class="text-sm text-gray-500">Loading…</p>
            </div>
            <div class="mt-3 flex flex-wrap items-center gap-2" id="familyFilters">
              <span class="text-sm text-gray-500 mr-1">Quick filters:</span>
              <button data-family="all" class="rounded-full border px-3 py-1 text-xs">All</button>
              <button data-family="Standard" class="rounded-full border px-3 py-1 text-xs">Standard</button>
              <button data-family="Pro" class="rounded-full border px-3 py-1 text-xs">Pro</button>
              <button data-family="Pro Max" class="rounded-full border px-3 py-1 text-xs">Pro Max</button>
              <button data-family="Air" class="rounded-full border px-3 py-1 text-xs">Air</button>
              <button id="resetFilters" class="ml-auto rounded-lg border px-3 py-1.5 text-sm">Reset</button>
            </div>
            <div class="mt-3 flex flex-wrap items-center gap-2" id="controls">
              <button id="refreshBtn" class="rounded-lg bg-brand-600 text-white px-3 py-1.5 text-sm hover:bg-brand-700 active:scale-[.98] transition">Refresh</button>
              <button id="toggleOnlyAvail" class="rounded-lg border px-3 py-1.5 text-sm">Only show available</button>
            </div>
          </div>
        </div>
      </section>

      <section>
        <!-- Responsive grid: 1 column on mobile/tablet, 2 on desktop -->
        <div id="stores" class="grid grid-cols-1 lg:grid-cols-2 gap-4"></div>
      </section>
    </main>

    <template id="store-card">
      <article class="rounded-2xl bg-white shadow-sm ring-1 ring-black/5 overflow-hidden flex flex-col">
        <div class="p-4">
          <h3 class="font-semibold text-base"></h3>
          <a class="mt-2 inline-block text-brand-700 text-sm hover:underline" target="_blank" rel="noopener noreferrer">View store info →</a>
        </div>
        <div class="border-t">
          <table class="w-full text-sm">
            <thead class="bg-gray-50 text-gray-600">
              <tr>
                <th class="text-left px-3 py-2">Model</th>
                <th class="text-right px-3 py-2">Pickup date</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </article>
    </template>

    <script>
      const state = { onlyAvail: false, data: null, families: new Set() };
      const elUpdated = document.getElementById('updated');
      const elStores = document.getElementById('stores');
      const elRefresh = document.getElementById('refreshBtn');
      const elToggleOnlyAvail = document.getElementById('toggleOnlyAvail');
      const elFamilyFilters = document.getElementById('familyFilters');
      const elReset = document.getElementById('resetFilters');
      const tmplStore = document.getElementById('store-card');

      function familyOf(part){
        const n = (part?.name||'').toLowerCase();
        if (n.includes('pro max')) return 'Pro Max';
        if (n.includes('pro')) return 'Pro';
        if (n.includes('air')) return 'Air';
        return 'Standard';
      }

      async function load(force=false){
        const url = new URL('/api/availability', location.origin);
        if (force) url.searchParams.set('force','1');
        try {
          const res = await fetch(url.toString());
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          state.data = data;
          const t = new Date(data.generatedAt || Date.now());
          elUpdated.textContent = 'Updated: ' + t.toLocaleString('en-US');

          render();
        } catch (err) {
          console.error('Failed to load availability:', err);
          state.data = null;
          elUpdated.textContent = 'Load failed. Please try again later.';
          elStores.innerHTML = '';
        }
      }

      elRefresh.addEventListener('click', ()=>load(true));
      elToggleOnlyAvail.addEventListener('click', ()=>{
        state.onlyAvail = !state.onlyAvail;
        elToggleOnlyAvail.classList.toggle('bg-brand-600');
        elToggleOnlyAvail.classList.toggle('text-white');
        render();
      });
      elReset.addEventListener('click', ()=>{ state.families.clear(); document.querySelector('[data-family=all]')?.click(); render(); });

      function wireInteractions(){
        elFamilyFilters.addEventListener('click', e => {
          const btn = e.target.closest('button[data-family]');
          if (!btn) return;
          const f = btn.getAttribute('data-family');
          if (f === 'all') {
            state.families.clear();
            elFamilyFilters.querySelectorAll('button[data-family]').forEach(b=>b.classList.remove('bg-gray-900','text-white'));
            btn.classList.add('bg-gray-900','text-white');
          } else {
            // toggle selection
            if (state.families.has(f)) {
              state.families.delete(f);
              btn.classList.remove('bg-gray-900','text-white');
            } else {
              state.families.add(f);
              btn.classList.add('bg-gray-900','text-white');
              // clear "All" highlight
              elFamilyFilters.querySelector('[data-family=all]')?.classList.remove('bg-gray-900','text-white');
            }
          }
          render();
        });
        // Highlight "All" initially
        elFamilyFilters.querySelector('[data-family=all]')?.classList.add('bg-gray-900','text-white');
      }

      function render(){
        if (!state.data) return;
        elStores.innerHTML = '';

        // group availability by store with filters
        const byStore = new Map();
        for (const a of state.data.availability){
          // Treat either explicit buyable flag or 'available' status as available
          if (state.onlyAvail && !(a.isBuyable || a.status === 'available')) continue;
          const fam = familyOf(a.part);
          if (state.families.size && !state.families.has(fam)) continue;
          const key = a.store.storeNumber || a.store.storeName;
          if (!byStore.has(key)) byStore.set(key, { store: a.store, list: [] });
          byStore.get(key).list.push(a);
        }

        let stores = Array.from(byStore.values());
        for (const g of stores){
          const node = tmplStore.content.cloneNode(true);
          const h3 = node.querySelector('h3');
          const link = node.querySelector('a');
          h3.textContent = g.store.storeName;
          link.href = g.store.url || '#';
          // Simplified: only keep a single store info link
          
          // Build grouped rows (no summary chips)
          const famOrder = ['Air','Pro Max','Pro','Standard'];
          const groups = new Map();
          for (const item of g.list){
            const fam = familyOf(item.part);
            if (!groups.has(fam)) groups.set(fam, []);
            groups.get(fam).push(item);
          }

          const tbody = node.querySelector('tbody');
          tbody.innerHTML = '';
          for (const fam of famOrder){
            const list = groups.get(fam)||[];
            if (!list.length) continue;
            const trh = document.createElement('tr');
            const th = document.createElement('td'); th.colSpan=2; th.className='bg-gray-50 px-3 py-2 text-xs text-gray-600'; th.textContent = fam;
            trh.appendChild(th); tbody.appendChild(trh);
            for (const item of list){
              const tr = document.createElement('tr');
              tr.className = 'border-t';
              const td1 = document.createElement('td');
              td1.className = 'px-3 py-2 text-gray-900';
              td1.textContent = item.part.name;
              // Robust price formatting: prefer numeric; fall back to raw string
              let price = '';
              if (item.part?.price !== undefined && item.part?.price !== null) {
                const n = Number(item.part.price);
                price = Number.isFinite(n) ? ('NT$' + n.toLocaleString('en-US')) : String(item.part.price);
              }
              if (price){
                const pz = document.createElement('div');
                pz.className='mt-1 text-xs text-gray-500';
                pz.textContent=price;
                td1.appendChild(pz);
              }
              const td2 = document.createElement('td');
              td2.className = 'px-3 py-2 text-right';
              td2.textContent = item.pickupQuote || ((item.isBuyable || item.status === 'available') ? 'Available' : 'Unavailable');
              tr.appendChild(td1); tr.appendChild(td2);
              tbody.appendChild(tr);
            }
          }
          elStores.appendChild(node);
        }
      }

      // Bind UI interactions once at startup
      wireInteractions();

      // Initial data load (subsequent refreshes won't re-bind interactions)
      load();
    </script>
  </body>
  </html>
