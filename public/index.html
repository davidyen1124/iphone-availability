<!doctype html>
<html lang="zh-Hant-TW">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>iPhone 17 系列台灣門市供貨</title>
    <meta name="description" content="自動擷取 apple.com/tw 的 iPhone 17 門市取貨可用日。" />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81'
              }
            }
          }
        }
      }
    </script>
    <style>
      .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,0.65); }
      .dark .glass { background: rgba(23,23,23,0.55); }
    </style>
  </head>
  <body class="min-h-dvh bg-gradient-to-b from-brand-50 to-white text-gray-900">
    <header class="sticky top-0 z-30 border-b bg-white/70 backdrop-blur supports-[backdrop-filter]:glass">
      <div class="mx-auto max-w-5xl px-4 py-3 flex items-center gap-3">
        <div>
          <h1 class="text-lg font-semibold leading-tight">iPhone 17 系列台灣門市供貨</h1>
          <p id="subtitle" class="text-xs text-gray-500">即時擷取 Apple 官網資料</p>
        </div>
        <div class="ml-auto flex items-center gap-2">
          <button id="refreshBtn" class="rounded-lg bg-brand-600 text-white px-3 py-1.5 text-sm hover:bg-brand-700 active:scale-[.98] transition">重新整理</button>
          <button id="toggleOnlyAvail" class="rounded-lg border px-3 py-1.5 text-sm">只看可取貨</button>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-5xl px-4 pb-20 pt-4">
      <section class="mb-4">
        <div class="rounded-2xl bg-white shadow-sm ring-1 ring-black/5 overflow-hidden">
          <div class="p-4 sm:p-6">
            <h2 class="font-semibold">所有 iPhone 17 系列機型</h2>
            <p id="updated" class="text-sm text-gray-500">載入中…</p>
            <div id="models" class="mt-2 flex flex-wrap gap-2"></div>
            <div class="mt-3 flex flex-wrap items-center gap-2" id="familyFilters">
              <span class="text-xs text-gray-500 mr-1">快速篩選：</span>
              <button data-family="all" class="rounded-full border px-3 py-1 text-xs">全部</button>
              <button data-family="Standard" class="rounded-full border px-3 py-1 text-xs">標準款</button>
              <button data-family="Pro" class="rounded-full border px-3 py-1 text-xs">Pro</button>
              <button data-family="Pro Max" class="rounded-full border px-3 py-1 text-xs">Pro Max</button>
              <button data-family="Air" class="rounded-full border px-3 py-1 text-xs">Air</button>
            </div>
            <div class="mt-3 flex flex-wrap items-center gap-2" id="controls">
              <div class="relative grow sm:w-72">
                <input id="q" type="text" placeholder="搜尋：顏色 / 容量 / 關鍵字" class="w-full rounded-lg border px-3 py-2 text-sm pl-9" />
                <span class="absolute left-3 top-2.5 text-gray-400">🔎</span>
              </div>
              <label class="text-sm text-gray-600 hidden sm:inline">排序</label>
              <select id="sortBy" class="rounded-lg border px-2 py-1.5 text-sm">
                <option value="store">門市名稱</option>
                <option value="available">可取貨優先</option>
              </select>
              <button id="resetFilters" class="rounded-lg border px-3 py-1.5 text-sm">重設</button>
            </div>
          </div>
        </div>
      </section>

      <section>
        <div id="stores" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </section>
    </main>

    <template id="store-card">
      <article class="rounded-2xl bg-white shadow-sm ring-1 ring-black/5 overflow-hidden flex flex-col">
        <div class="p-4">
          <h3 class="font-semibold text-base"></h3>
          <p class="text-sm text-gray-500"></p>
          <a class="mt-2 inline-block text-brand-700 text-sm hover:underline" target="_blank" rel="noreferrer">前往門市資訊 →</a>
        </div>
        <div class="border-t">
          <table class="w-full text-sm">
            <thead class="bg-gray-50 text-gray-600">
              <tr>
                <th class="text-left px-3 py-2">機型</th>
                <th class="text-right px-3 py-2">取貨日</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </article>
    </template>

    <script>
      const state = { onlyAvail: false, data: null, families: new Set(), q: '', sortBy: 'store' };
      const elUpdated = document.getElementById('updated');
      const elModels = document.getElementById('models');
      const elStores = document.getElementById('stores');
      const elRefresh = document.getElementById('refreshBtn');
      const elToggleOnlyAvail = document.getElementById('toggleOnlyAvail');
      const elFamilyFilters = document.getElementById('familyFilters');
      const elQ = document.getElementById('q');
      const elSort = document.getElementById('sortBy');
      const elReset = document.getElementById('resetFilters');
      const tmplStore = document.getElementById('store-card');

      function familyOf(part){
        const n = (part?.name||'').toLowerCase();
        if (n.includes('pro max')) return 'Pro Max';
        if (n.includes('pro')) return 'Pro';
        if (n.includes('air')) return 'Air';
        return 'Standard';
      }

      async function load(force=false){
        const url = new URL('/api/availability', location.origin);
        if (force) url.searchParams.set('force','1');
        const res = await fetch(url.toString());
        const data = await res.json();
        state.data = data;
        const t = new Date(data.generatedAt || Date.now());
        elUpdated.textContent = '資料時間：' + t.toLocaleString('zh-TW');

        // build model chips
        elModels.innerHTML = '';
        const seen = new Set();
        for (const p of data.models||[]){
          if (seen.has(p.partNumber)) continue; seen.add(p.partNumber);
          const chip = document.createElement('span');
          chip.className = 'inline-flex items-center gap-2 rounded-full border px-2 py-1 text-xs';
          const dot = document.createElement('span'); dot.className='inline-block w-1.5 h-1.5 rounded-full bg-brand-600';
          chip.appendChild(dot);
          chip.appendChild(document.createTextNode(p.name||p.partNumber));
          elModels.appendChild(chip);
        }
        wireInteractions();
        render();
      }

      elRefresh.addEventListener('click', ()=>load(true));
      elToggleOnlyAvail.addEventListener('click', ()=>{
        state.onlyAvail = !state.onlyAvail;
        elToggleOnlyAvail.classList.toggle('bg-brand-600');
        elToggleOnlyAvail.classList.toggle('text-white');
        render();
      });
      elQ.addEventListener('input', ()=>{ state.q = elQ.value.trim(); render(); });
      elSort.addEventListener('change', ()=>{ state.sortBy = elSort.value; render(); });
      elReset.addEventListener('click', ()=>{ state.q = ''; elQ.value=''; state.families.clear(); document.querySelector('[data-family=all]')?.click(); render(); });

      function wireInteractions(){
        elFamilyFilters.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', ()=>{
            const f = btn.getAttribute('data-family');
            if (f === 'all') {
              state.families.clear();
              elFamilyFilters.querySelectorAll('button').forEach(b=>b.classList.remove('bg-gray-900','text-white'));
              btn.classList.add('bg-gray-900','text-white');
            } else {
              // toggle selection
              if (state.families.has(f)) {
                state.families.delete(f);
                btn.classList.remove('bg-gray-900','text-white');
              } else {
                state.families.add(f);
                btn.classList.add('bg-gray-900','text-white');
                // clear "全部" highlight
                elFamilyFilters.querySelector('[data-family=all]')?.classList.remove('bg-gray-900','text-white');
              }
            }
            render();
          });
        });
        // Highlight "全部" initially
        elFamilyFilters.querySelector('[data-family=all]')?.classList.add('bg-gray-900','text-white');
      }

      function render(){
        if (!state.data) return;
        elStores.innerHTML = '';

        // group availability by store with filters/search
        const byStore = new Map();
        for (const a of state.data.availability){
          if (state.onlyAvail && a.status !== 'available') continue;
          const fam = familyOf(a.part);
          if (state.families.size && !state.families.has(fam)) continue;
          if (state.q) {
            const hay = (a.part.name + ' ' + (a.part.partNumber||'')).toLowerCase();
            if (!hay.includes(state.q.toLowerCase())) continue;
          }
          const key = a.store.storeNumber || a.store.storeName;
          if (!byStore.has(key)) byStore.set(key, { store: a.store, list: [] });
          byStore.get(key).list.push(a);
        }

        let stores = Array.from(byStore.values());
        if (state.sortBy === 'available') {
          stores.sort((a,b)=> {
            const aa = a.list.some(x=>x.status==='available' || x.isBuyable);
            const bb = b.list.some(x=>x.status==='available' || x.isBuyable);
            if (aa!==bb) return aa? -1: 1;
            return (a.store.storeName||'').localeCompare(b.store.storeName||'');
          });
        } else {
          stores.sort((a,b)=> (a.store.storeName||'').localeCompare(b.store.storeName||''));
        }
        for (const g of stores){
          const node = tmplStore.content.cloneNode(true);
          const h3 = node.querySelector('h3');
          const p = node.querySelector('p');
          const link = node.querySelector('a');
          h3.textContent = g.store.storeName;
          p.textContent = (g.store.city || '') + ' · ' + (g.store.address || '');
          link.href = g.store.url || '#';
          // Simplified: only keep a single store info link
          
          // Build family summaries and grouped rows
          const famOrder = ['Air','Pro Max','Pro','Standard'];
          const groups = new Map();
          for (const item of g.list){
            const fam = familyOf(item.part);
            if (!groups.has(fam)) groups.set(fam, []);
            groups.get(fam).push(item);
          }
          // summary chips
          const card = node.querySelector('article');
          const summary = document.createElement('div');
          summary.className = 'px-4 pb-2 flex flex-wrap gap-2 text-xs';
          for (const fam of famOrder){
            const list = groups.get(fam)||[];
            if (!list.length) continue;
            const avail = list.filter(x=>x.status==='available' || x.isBuyable).length;
            const chip = document.createElement('span');
            chip.className = 'rounded-full border px-2 py-1';
            chip.textContent = fam + '：' + avail + '/' + list.length;
            summary.appendChild(chip);
          }
          card.insertBefore(summary, card.children[1]);

          const tbody = node.querySelector('tbody');
          tbody.innerHTML = '';
          for (const fam of famOrder){
            const list = groups.get(fam)||[];
            if (!list.length) continue;
            const trh = document.createElement('tr');
            const th = document.createElement('td'); th.colSpan=2; th.className='bg-gray-50 px-3 py-2 text-xs text-gray-600'; th.textContent = fam;
            trh.appendChild(th); tbody.appendChild(trh);
            for (const item of list){
              const tr = document.createElement('tr');
              tr.className = 'border-t';
              const td1 = document.createElement('td');
              td1.className = 'px-3 py-2 text-gray-900';
              td1.textContent = item.part.name;
              const price = item.part.price ? ('NT$' + Number(item.part.price).toLocaleString('zh-TW')) : '';
              if (price){ const pz = document.createElement('span'); pz.className='ml-2 text-xs text-gray-500'; pz.textContent=price; td1.appendChild(pz); }
              const td2 = document.createElement('td');
              td2.className = 'px-3 py-2 text-right';
              const badge = document.createElement('span');
              badge.className = 'inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs font-medium ' + (item.status === 'available' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-700');
              badge.textContent = item.pickupQuote || (item.status === 'available' ? '可取貨' : '暫無供貨');
              td2.appendChild(badge);
              tr.appendChild(td1); tr.appendChild(td2);
              tbody.appendChild(tr);
            }
          }
          elStores.appendChild(node);
        }
      }

      load();
    </script>
  </body>
  </html>
